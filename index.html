<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”¨ æ‰“åœ°é¼  â€” Whack-a-Mole!</title>
    <meta name="description" content="A fun cartoon-style whack-a-mole game">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* â”€â”€â”€ Reset & Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --green-light: #7ec850;
            --green-dark: #5a9e32;
            --sky-top: #87ceeb;
            --sky-bottom: #e0f4ff;
            --brown-light: #c8956c;
            --brown-dark: #8b5e3c;
            --brown-hole: #3d2417;
            --gold: #ffd700;
            --red: #ff4757;
            --purple: #a855f7;
            --pink: #ec4899;
            --card-bg: rgba(255,255,255,0.85);
            --shadow: 0 8px 32px rgba(0,0,0,0.12);
        }

        body {
            font-family: 'Fredoka', sans-serif;
            background: linear-gradient(180deg, var(--sky-top) 0%, var(--sky-bottom) 40%, var(--green-light) 40%, var(--green-dark) 100%);
            min-height: 100vh;
            overflow-x: hidden;
            color: #2d3436;
        }

        /* â”€â”€â”€ Clouds â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .clouds {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 40vh;
            pointer-events: none;
            overflow: hidden;
            z-index: 0;
        }
        .cloud {
            position: absolute;
            background: white;
            border-radius: 50px;
            opacity: 0.8;
        }
        .cloud::before, .cloud::after {
            content: '';
            position: absolute;
            background: white;
            border-radius: 50%;
        }
        .cloud-1 { width: 120px; height: 40px; top: 8%; animation: float-cloud 25s linear infinite; }
        .cloud-1::before { width: 50px; height: 50px; top: -25px; left: 20px; }
        .cloud-1::after { width: 70px; height: 60px; top: -30px; left: 50px; }
        .cloud-2 { width: 160px; height: 50px; top: 15%; animation: float-cloud 35s linear infinite 5s; }
        .cloud-2::before { width: 60px; height: 60px; top: -30px; left: 30px; }
        .cloud-2::after { width: 80px; height: 70px; top: -35px; left: 70px; }
        .cloud-3 { width: 100px; height: 35px; top: 5%; animation: float-cloud 30s linear infinite 12s; }
        .cloud-3::before { width: 45px; height: 45px; top: -22px; left: 15px; }
        .cloud-3::after { width: 55px; height: 50px; top: -25px; left: 40px; }
        @keyframes float-cloud {
            from { left: -200px; }
            to { left: 110%; }
        }

        /* â”€â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 20px 15px;
            position: relative;
            z-index: 1;
        }

        /* â”€â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .header h1 {
            font-size: 2.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--brown-dark), var(--red), var(--purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: none;
            filter: drop-shadow(2px 2px 0 rgba(0,0,0,0.1));
            line-height: 1.2;
        }
        .header .subtitle {
            font-size: 1rem;
            color: #636e72;
            margin-top: 4px;
        }

        /* â”€â”€â”€ Status Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .status-bar {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .status-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 12px 20px;
            box-shadow: var(--shadow);
            text-align: center;
            min-width: 100px;
            border: 2px solid rgba(255,255,255,0.6);
            transition: transform 0.2s;
        }
        .status-card:hover { transform: translateY(-2px); }
        .status-card .label { font-size: 0.75rem; color: #636e72; text-transform: uppercase; letter-spacing: 1px; }
        .status-card .value { font-size: 1.8rem; font-weight: 700; margin-top: 2px; }
        .status-card .value.score-value { color: var(--gold); text-shadow: 1px 1px 0 #b8860b; }
        .status-card .value.time-value { color: var(--red); }
        .status-card .value.streak-value { color: var(--purple); }
        .status-card .value.combo-value { color: var(--pink); }

        /* â”€â”€â”€ Connection Badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .connection-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin-bottom: 16px;
            font-size: 0.8rem;
            color: #636e72;
        }
        .conn-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: #ccc;
            transition: background 0.3s;
        }
        .conn-dot.online { background: #00b894; box-shadow: 0 0 6px #00b894; }
        .conn-dot.offline { background: var(--red); box-shadow: 0 0 6px var(--red); }

        /* â”€â”€â”€ Game Board â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .game-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            max-width: 450px;
            margin: 0 auto 24px;
        }
        .hole {
            position: relative;
            width: 100%;
            aspect-ratio: 1;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        .hole-ground {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 110%;
            height: 40%;
            background: radial-gradient(ellipse, var(--brown-hole) 50%, transparent 70%);
            border-radius: 50%;
            z-index: 2;
        }
        .hole-front {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 110%;
            height: 20%;
            background: linear-gradient(to bottom, var(--green-dark), var(--green-light));
            border-radius: 50%;
            z-index: 4;
        }

        /* â”€â”€â”€ Mole â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .mole {
            position: absolute;
            bottom: 15%;
            left: 50%;
            transform: translateX(-50%) translateY(100%);
            width: 65%;
            height: 65%;
            z-index: 3;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: none;
        }
        .mole.show {
            transform: translateX(-50%) translateY(10%);
        }
        .mole.hit {
            transform: translateX(-50%) translateY(10%) scale(0.8);
        }
        .mole-body {
            width: 100%;
            height: 100%;
            position: relative;
        }
        .mole-head {
            width: 80%;
            height: 70%;
            background: var(--brown-light);
            border-radius: 50% 50% 45% 45%;
            margin: 0 auto;
            position: relative;
            box-shadow: inset -5px -5px 10px rgba(0,0,0,0.15);
        }
        .mole-eye {
            width: 18%;
            height: 22%;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 32%;
            box-shadow: inset 2px 2px 3px rgba(0,0,0,0.1);
        }
        .mole-eye.left { left: 20%; }
        .mole-eye.right { right: 20%; }
        .mole-eye::after {
            content: '';
            width: 55%;
            height: 55%;
            background: #2d3436;
            border-radius: 50%;
            position: absolute;
            top: 25%;
            left: 25%;
        }
        .mole-nose {
            width: 22%;
            height: 16%;
            background: #e17055;
            border-radius: 50%;
            position: absolute;
            bottom: 28%;
            left: 50%;
            transform: translateX(-50%);
        }
        .mole-cheek {
            width: 16%;
            height: 12%;
            background: rgba(255,150,150,0.5);
            border-radius: 50%;
            position: absolute;
            bottom: 25%;
        }
        .mole-cheek.left { left: 8%; }
        .mole-cheek.right { right: 8%; }
        .mole-mouth {
            width: 30%;
            height: 8%;
            border-bottom: 3px solid #8b5e3c;
            border-radius: 0 0 50% 50%;
            position: absolute;
            bottom: 18%;
            left: 50%;
            transform: translateX(-50%);
        }

        /* Mole hit state */
        .mole.hit .mole-eye::after {
            content: 'Ã—';
            background: none;
            color: #2d3436;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .mole.hit .mole-mouth {
            border-bottom: none;
            border-top: 3px solid #8b5e3c;
            border-radius: 50% 50% 0 0;
            bottom: 20%;
        }

        /* â”€â”€â”€ Hit Effect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .hit-effect {
            position: absolute;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gold);
            text-shadow: 1px 1px 0 #b8860b;
            z-index: 10;
            pointer-events: none;
            animation: hit-float 0.8s ease-out forwards;
        }
        @keyframes hit-float {
            0% { opacity: 1; transform: translateX(-50%) translateY(0) scale(1); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-40px) scale(1.3); }
        }

        /* â”€â”€â”€ Stars burst â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .star-burst {
            position: absolute;
            z-index: 10;
            pointer-events: none;
        }
        .star {
            position: absolute;
            font-size: 1rem;
            animation: star-fly 0.6s ease-out forwards;
        }
        @keyframes star-fly {
            0% { opacity: 1; transform: translate(0, 0) scale(1); }
            100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(0.3); }
        }

        /* â”€â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .controls {
            text-align: center;
            margin-bottom: 24px;
        }
        .btn {
            font-family: 'Fredoka', sans-serif;
            font-size: 1.2rem;
            font-weight: 600;
            padding: 14px 40px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .btn:active { transform: scale(0.95); }
        .btn-start {
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
        }
        .btn-start:hover { box-shadow: 0 6px 20px rgba(0,184,148,0.4); transform: translateY(-2px); }
        .btn-start:disabled {
            background: #b2bec3;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* â”€â”€â”€ Leaderboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .leaderboard {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 24px;
            box-shadow: var(--shadow);
            border: 2px solid rgba(255,255,255,0.6);
        }
        .leaderboard h2 {
            text-align: center;
            font-size: 1.5rem;
            margin-bottom: 16px;
            color: var(--brown-dark);
        }
        .leaderboard table {
            width: 100%;
            border-collapse: collapse;
        }
        .leaderboard th {
            padding: 8px 12px;
            text-align: left;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #636e72;
            border-bottom: 2px solid #dfe6e9;
        }
        .leaderboard td {
            padding: 10px 12px;
            font-size: 0.95rem;
            border-bottom: 1px solid #f0f0f0;
        }
        .leaderboard tr:last-child td { border-bottom: none; }
        .leaderboard .rank-1 td { background: rgba(255,215,0,0.1); }
        .leaderboard .rank-2 td { background: rgba(192,192,192,0.1); }
        .leaderboard .rank-3 td { background: rgba(205,127,50,0.1); }
        .rank-medal { font-size: 1.2rem; }

        /* â”€â”€â”€ Game Over Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: white;
            border-radius: 24px;
            padding: 36px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modal-pop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes modal-pop {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .modal h2 { font-size: 2rem; margin-bottom: 8px; }
        .modal .final-score { font-size: 3.5rem; font-weight: 700; color: var(--gold); text-shadow: 2px 2px 0 #b8860b; }
        .modal .final-message { color: #636e72; margin: 12px 0 20px; font-size: 1rem; }
        .modal input {
            font-family: 'Fredoka', sans-serif;
            font-size: 1rem;
            padding: 12px 16px;
            border: 2px solid #dfe6e9;
            border-radius: 12px;
            width: 100%;
            text-align: center;
            margin-bottom: 16px;
            outline: none;
            transition: border-color 0.2s;
        }
        .modal input:focus { border-color: var(--purple); }
        .modal .btn-submit {
            background: linear-gradient(135deg, var(--purple), var(--pink));
            color: white;
            width: 100%;
        }
        .modal .btn-submit:hover { box-shadow: 0 6px 20px rgba(168,85,247,0.4); transform: translateY(-2px); }
        .modal .btn-skip {
            background: none;
            color: #b2bec3;
            box-shadow: none;
            font-size: 0.9rem;
            margin-top: 8px;
        }

        /* â”€â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .footer {
            text-align: center;
            padding: 20px;
            font-size: 0.8rem;
            color: rgba(255,255,255,0.7);
        }
        .footer a { color: rgba(255,255,255,0.9); text-decoration: none; }

        /* â”€â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @media (max-width: 500px) {
            .header h1 { font-size: 2rem; }
            .game-board { gap: 10px; max-width: 320px; }
            .status-card { min-width: 75px; padding: 8px 12px; }
            .status-card .value { font-size: 1.4rem; }
        }
    </style>
</head>
<body>
    <!-- Clouds -->
    <div class="clouds">
        <div class="cloud cloud-1"></div>
        <div class="cloud cloud-2"></div>
        <div class="cloud cloud-3"></div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸ”¨ æ‰“åœ°é¼ </h1>
            <p class="subtitle">Whack-a-Mole! â€” å¿«é€Ÿç‚¹å‡»å†’å‡ºçš„åœ°é¼ ï¼</p>
        </div>

        <!-- Connection Status -->
        <div class="connection-badge">
            <span class="conn-dot" id="connDot"></span>
            <span id="connText">è¿æ¥ä¸­...</span>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-card">
                <div class="label">åˆ†æ•°</div>
                <div class="value score-value" id="scoreDisplay">0</div>
            </div>
            <div class="status-card">
                <div class="label">æ—¶é—´</div>
                <div class="value time-value" id="timeDisplay">30</div>
            </div>
            <div class="status-card">
                <div class="label">è¿å‡»</div>
                <div class="value streak-value" id="streakDisplay">0</div>
            </div>
            <div class="status-card">
                <div class="label">æœ€é«˜è¿å‡»</div>
                <div class="value combo-value" id="maxStreakDisplay">0</div>
            </div>
        </div>

        <!-- Game Board -->
        <div class="game-board" id="gameBoard"></div>

        <!-- Controls -->
        <div class="controls">
            <button class="btn btn-start" id="startBtn" onclick="startGame()">ğŸ® å¼€å§‹æ¸¸æˆ</button>
        </div>

        <!-- Leaderboard -->
        <div class="leaderboard">
            <h2>ğŸ† æ’è¡Œæ¦œ</h2>
            <table>
                <thead>
                    <tr><th>æ’å</th><th>ç©å®¶</th><th>åˆ†æ•°</th></tr>
                </thead>
                <tbody id="leaderboardBody">
                    <tr><td colspan="3" style="text-align:center;color:#b2bec3;">åŠ è½½ä¸­...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="footer">
            <p>Made with â¤ï¸ for Dokploy Testing | <a href="/api/health" target="_blank">API Health</a></p>
        </div>
    </div>

    <!-- Game Over Modal -->
    <div class="modal-overlay" id="gameOverModal">
        <div class="modal">
            <h2>ğŸ‰ æ¸¸æˆç»“æŸ!</h2>
            <div class="final-score" id="finalScore">0</div>
            <div class="final-message" id="finalMessage">å¹²å¾—æ¼‚äº®!</div>
            <input type="text" id="playerName" placeholder="è¾“å…¥ä½ çš„åå­—..." maxlength="20">
            <button class="btn btn-submit" onclick="submitScore()">ğŸ“¤ æäº¤åˆ†æ•°</button>
            <button class="btn btn-skip" onclick="closeModal()">è·³è¿‡</button>
        </div>
    </div>

    <script src="/config.js"></script>
    <script>
        // â”€â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const API_BASE = (window.APP_CONFIG && window.APP_CONFIG.API_BASE_URL) || '';

        // â”€â”€â”€ Game State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let gameConfig = {
            game_duration: 30, grid_size: 9,
            mole_show_min_ms: 600, mole_show_max_ms: 1200,
            mole_interval_min_ms: 400, mole_interval_max_ms: 900,
            points_per_hit: 10, bonus_per_streak: 5, streak_threshold: 3,
        };
        let score = 0, timeLeft = 30, streak = 0, maxStreak = 0;
        let gameActive = false, gameTimer = null, moleTimers = [];

        // â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function init() {
            buildBoard();
            checkConnection();
            loadConfig();
            loadLeaderboard();
        }

        function buildBoard() {
            const board = document.getElementById('gameBoard');
            board.innerHTML = '';
            for (let i = 0; i < 9; i++) {
                const hole = document.createElement('div');
                hole.className = 'hole';
                hole.id = `hole-${i}`;
                hole.innerHTML = `
                    <div class="mole" id="mole-${i}">
                        <div class="mole-body">
                            <div class="mole-head">
                                <div class="mole-eye left"></div>
                                <div class="mole-eye right"></div>
                                <div class="mole-nose"></div>
                                <div class="mole-cheek left"></div>
                                <div class="mole-cheek right"></div>
                                <div class="mole-mouth"></div>
                            </div>
                        </div>
                    </div>
                    <div class="hole-ground"></div>
                    <div class="hole-front"></div>
                `;
                hole.addEventListener('click', () => whack(i));
                board.appendChild(hole);
            }
        }

        // â”€â”€â”€ API Calls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function checkConnection() {
            const dot = document.getElementById('connDot');
            const text = document.getElementById('connText');
            try {
                const res = await fetch(`${API_BASE}/api/health`);
                const data = await res.json();
                dot.className = 'conn-dot online';
                text.textContent = `âœ… åç«¯å·²è¿æ¥ (${data.service} v${data.version})`;
            } catch (e) {
                dot.className = 'conn-dot offline';
                text.textContent = 'âŒ åç«¯æœªè¿æ¥ â€” æ¸¸æˆä»å¯å•æœºè¿è¡Œ';
            }
        }

        async function loadConfig() {
            try {
                const res = await fetch(`${API_BASE}/api/game/config`);
                gameConfig = await res.json();
                timeLeft = gameConfig.game_duration;
                document.getElementById('timeDisplay').textContent = timeLeft;
            } catch (e) { /* use defaults */ }
        }

        async function loadLeaderboard() {
            try {
                const res = await fetch(`${API_BASE}/api/scores`);
                const data = await res.json();
                renderLeaderboard(data.leaderboard);
            } catch (e) {
                document.getElementById('leaderboardBody').innerHTML =
                    '<tr><td colspan="3" style="text-align:center;color:#b2bec3;">æš‚æ— æ•°æ®ï¼ˆåç«¯æœªè¿æ¥ï¼‰</td></tr>';
            }
        }

        function renderLeaderboard(list) {
            const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
            const tbody = document.getElementById('leaderboardBody');
            if (!list || list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#b2bec3;">æš‚æ— è®°å½•</td></tr>';
                return;
            }
            tbody.innerHTML = list.map((s, i) => `
                <tr class="rank-${i + 1}">
                    <td><span class="rank-medal">${medals[i] || (i + 1)}</span></td>
                    <td>${s.name}</td>
                    <td><strong>${s.score}</strong></td>
                </tr>
            `).join('');
        }

        // â”€â”€â”€ Game Logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function startGame() {
            score = 0; streak = 0; maxStreak = 0;
            timeLeft = gameConfig.game_duration;
            gameActive = true;
            updateDisplay();

            document.getElementById('startBtn').disabled = true;

            // Clear all moles
            for (let i = 0; i < 9; i++) {
                const mole = document.getElementById(`mole-${i}`);
                mole.classList.remove('show', 'hit');
                mole.dataset.active = 'false';
            }

            // Start timer
            gameTimer = setInterval(() => {
                timeLeft--;
                document.getElementById('timeDisplay').textContent = timeLeft;
                if (timeLeft <= 0) endGame();
            }, 1000);

            // Start spawning moles
            spawnMoles();
        }

        function spawnMoles() {
            if (!gameActive) return;
            const delay = randomBetween(gameConfig.mole_interval_min_ms, gameConfig.mole_interval_max_ms);
            const timer = setTimeout(() => {
                if (!gameActive) return;
                showRandomMole();
                spawnMoles();
            }, delay);
            moleTimers.push(timer);
        }

        function showRandomMole() {
            const available = [];
            for (let i = 0; i < 9; i++) {
                const mole = document.getElementById(`mole-${i}`);
                if (mole.dataset.active !== 'true') available.push(i);
            }
            if (available.length === 0) return;

            const idx = available[Math.floor(Math.random() * available.length)];
            const mole = document.getElementById(`mole-${idx}`);
            mole.classList.remove('hit');
            mole.classList.add('show');
            mole.dataset.active = 'true';

            const showTime = randomBetween(gameConfig.mole_show_min_ms, gameConfig.mole_show_max_ms);
            const timer = setTimeout(() => {
                if (mole.dataset.active === 'true') {
                    mole.classList.remove('show');
                    mole.dataset.active = 'false';
                    if (gameActive) { streak = 0; updateDisplay(); }
                }
            }, showTime);
            moleTimers.push(timer);
        }

        function whack(idx) {
            if (!gameActive) return;
            const mole = document.getElementById(`mole-${idx}`);
            if (mole.dataset.active !== 'true') return;

            mole.dataset.active = 'false';
            mole.classList.add('hit');

            // Score
            streak++;
            if (streak > maxStreak) maxStreak = streak;
            let points = gameConfig.points_per_hit;
            if (streak >= gameConfig.streak_threshold) {
                points += gameConfig.bonus_per_streak * (streak - gameConfig.streak_threshold + 1);
            }
            score += points;
            updateDisplay();

            // Effects
            showHitEffect(idx, `+${points}`);
            showStars(idx);

            setTimeout(() => {
                mole.classList.remove('show', 'hit');
            }, 300);
        }

        function endGame() {
            gameActive = false;
            clearInterval(gameTimer);
            moleTimers.forEach(t => clearTimeout(t));
            moleTimers = [];

            // Hide all moles
            for (let i = 0; i < 9; i++) {
                const mole = document.getElementById(`mole-${i}`);
                mole.classList.remove('show', 'hit');
                mole.dataset.active = 'false';
            }

            document.getElementById('startBtn').disabled = false;
            document.getElementById('finalScore').textContent = score;
            document.getElementById('finalMessage').textContent =
                score >= 200 ? 'ğŸ† åœ°é¼ ç»ˆç»“è€…ï¼' :
                score >= 100 ? 'ğŸ”¥ å¤ªå‰å®³äº†ï¼' :
                score >= 50 ? 'ğŸ‘ ç»§ç»­åŠ æ²¹ï¼' : 'ğŸ˜Š ä¸‹æ¬¡ä¼šæ›´å¥½ï¼';
            document.getElementById('gameOverModal').classList.add('show');
        }

        async function submitScore() {
            const name = document.getElementById('playerName').value.trim() || 'åŒ¿åç©å®¶';
            try {
                const res = await fetch(`${API_BASE}/api/scores`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, score, level: Math.ceil(score / 50) }),
                });
                const data = await res.json();
                alert(`${data.message}\nä½ çš„æ’å: #${data.rank} / ${data.total_players}`);
            } catch (e) {
                alert('æäº¤å¤±è´¥ï¼Œåç«¯æœªè¿æ¥');
            }
            closeModal();
            loadLeaderboard();
        }

        function closeModal() {
            document.getElementById('gameOverModal').classList.remove('show');
            document.getElementById('playerName').value = '';
        }

        // â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function updateDisplay() {
            document.getElementById('scoreDisplay').textContent = score;
            document.getElementById('timeDisplay').textContent = timeLeft;
            document.getElementById('streakDisplay').textContent = streak;
            document.getElementById('maxStreakDisplay').textContent = maxStreak;
        }

        function showHitEffect(idx, text) {
            const hole = document.getElementById(`hole-${idx}`);
            const el = document.createElement('div');
            el.className = 'hit-effect';
            el.textContent = text;
            hole.appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        function showStars(idx) {
            const hole = document.getElementById(`hole-${idx}`);
            const emojis = ['â­', 'âœ¨', 'ğŸ’¥', 'ğŸŒŸ'];
            for (let i = 0; i < 4; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.textContent = emojis[i];
                const angle = (i / 4) * Math.PI * 2;
                star.style.setProperty('--tx', `${Math.cos(angle) * 40}px`);
                star.style.setProperty('--ty', `${Math.sin(angle) * 40}px`);
                star.style.left = '45%';
                star.style.top = '30%';

                const burst = document.createElement('div');
                burst.className = 'star-burst';
                burst.appendChild(star);
                hole.appendChild(burst);
                setTimeout(() => burst.remove(), 600);
            }
        }

        function randomBetween(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // â”€â”€â”€ Start â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        init();
    </script>
</body>
</html>
